---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
# %autosave 0
# %load_ext autoreload
# %autoreload 2
import sys
sys.path.append("../../src/python")
sys.path.append("../../src/asp")
from IPython.display import Video
import pandas as pd


from rsp.step_03_run.experiments import *
from rsp.step_04_analysis.detailed_experiment_analysis.detailed_experiment_analysis import *
from rsp.step_04_analysis.detailed_experiment_analysis.resources_plotting_information import *
from rsp.step_04_analysis.detailed_experiment_analysis.flatland_rendering import *

from rsp.step_04_analysis.plot_utils import *
from rsp.utils.global_data_configuration import *
from rsp.utils.resource_occupation import *
from rsp.scheduling.asp.asp_helper import _print_stats


BASELINE_DATA_FOLDER = f"../../{BASELINE_DATA_FOLDER}"
```

```{python}
experiment_base_directory = BASELINE_DATA_FOLDER

experiment_of_interest = 0
```

```{python}
experiment_data_directory = f'{experiment_base_directory}/{EXPERIMENT_DATA_SUBDIRECTORY_NAME}'

exp_results_of_experiment_of_interest = load_and_expand_experiment_results_from_data_folder(
    experiment_data_folder_name=experiment_data_directory,
    experiment_ids=[experiment_of_interest],
    nonify_all_structured_fields=False
)[0]
agent_of_interest = exp_results_of_experiment_of_interest.experiment_parameters.re_schedule_parameters.malfunction_agent_id
```

```{python}
resource_occupations_for_all_scopes = extract_resource_occupations_for_all_scopes(experiment_result=exp_results_of_experiment_of_interest)
plotting_information: PlottingInformation = extract_plotting_information(
    schedule_as_resource_occupations=resource_occupations_for_all_scopes.schedule,
    grid_depth=exp_results_of_experiment_of_interest.experiment_parameters.infra_parameters.width,
    sorting_agent_id=agent_of_interest
)
```

```{python}
print(f"agent_of_interest={agent_of_interest}")
```

### Visualize solutions


The figure below shows the initial schedule we use as input to our re-scheduling pipeline. It is taken as given as used as target for optimization (minimal delay to initial schedule)

```{python}
plot_time_resource_trajectories_all_scopes(experiment_results=exp_results_of_experiment_of_interest, plotting_information=plotting_information)
```

```{python}
plot_changed_agents(exp_results_of_experiment_of_interest)
```

### Visualize Problems

```{python}
print_path_stats(experiment_results=exp_results_of_experiment_of_interest)
plot_nb_route_alternatives(experiment_results=exp_results_of_experiment_of_interest)
```

```{python}
plot_agent_speeds(experiment_results=exp_results_of_experiment_of_interest)
```

```{python}
plot_time_window_sizes(experiment_results=exp_results_of_experiment_of_interest)
```

### Visualize Problem instances as time-resource graphs
This visualization shows the parameter spaced available to the optimizer to find solutions. Initial schedule is not shown as we have a tabularasa approach with no restrictions.
Full rescheduling has the following available parameter space
Using the perfect oracle we can reduce the available parameters to disjunct patches in the space-time-continuum ;)

```{python}
plot_time_windows_all_scopes(experiment_results=exp_results_of_experiment_of_interest, plotting_information=plotting_information)
```

```{python}
plot_shared_heatmap(plotting_information=plotting_information,experiment_result=exp_results_of_experiment_of_interest)
```

### Some metrics about the schedule


Number of active agents at each time step for the initial schedule

```{python}
plot_time_density(schedule_as_resource_occupations=resource_occupations_for_all_scopes.schedule)
```

Below we plot the resource occupation for the schedule and the difference between to the re-schedule as well as an indication of where agents start and where they travel. THe circles represent number of agents that either start or end at the city location.

```{python}
plot_resource_occupation_heat_map(
    schedule_as_resource_occupations=resource_occupations_for_all_scopes.schedule,
    reschedule_as_resource_occupations=resource_occupations_for_all_scopes.offline_delta,
    plotting_information=plotting_information,
    title_suffix='Schedule'
)
```

Detailed paths of single trains

```{python}
plot_train_paths(
        schedule_as_resource_occupations=resource_occupations_for_all_scopes.schedule,
    plotting_information=plotting_information,
        agent_ids= [agent_of_interest])
```

```{python}
video_src_schedule, video_src_reschedule=render_flatland_env(data_folder=experiment_base_directory,
                        experiment_data=exp_results_of_experiment_of_interest,
                        experiment_id=experiment_of_interest,
                        render_schedule = True,
                        render_reschedule = True)
```

```{python}
Video(video_src_schedule, embed=True)
```

```{python}
# %matplotlib inline
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_SCHEDULE)
```

```{python}
# %matplotlib inline
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_RSP_FULL_AFTER_MALFUNCTION)
```

```{python}
# %matplotlib inline
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_RSP_DELTA_PERFECT_AFTER_MALFUNCTION)
```

### solver statistics

```{python}
for scope in all_scopes:
    results_scope = exp_results_of_experiment_of_interest._asdict()[f"results_{scope}"]
    print("=================================================================================")
    print("=================================================================================")
    print(f"= {scope} =")
    print("=================================================================================")
    print("=================================================================================")
    _print_stats(results_scope.solver_statistics)
    print("\n\n\n\n")

```
