apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-test"
  annotations:
    "helm.sh/hook": test-success
spec:
  restartPolicy: Never
  containers:
    - image: "docker.bin.sbb.ch/pfi/rsp-workspace:{{ .Values.RspWorkspaceVersion }}"
      imagePullPolicy: IfNotPresent # Always or IfNotPresent
      name: "{{ .Release.Name }}"
      env:
        # set GIT_SSH_COMMAND to access the private key mounted
        - name: GIT_SSH_COMMAND
          value: "ssh -o ProxyCommand='connect -S zscaler.sbb.ch:10465 %h %p' -i /home/jovyan/ssh/ssh-privatekey -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no"
      args:
        - /bin/bash
        - -c
        - |
          # echo shell commands and fail script on error
          set -e
          set -x
          source set-sbb-proxy
          printenv
          git clone git@github.com:SchweizerischeBundesbahnen/rsp.git -b {{ .Values.RspWorkspaceVersion }} --recurse-submodules
          git clone git@github.com:SchweizerischeBundesbahnen/rsp-data.git

          # set up environment
          cd rsp
          conda init bash
          source ~/.bashrc

          # set up conda environment with dependencies and requirement for ci (testing, linting etc.)
          conda env create --file rsp_environment.yml --force
          conda activate rsp

          xvfb-run python tests/03_integration_tests/test_notebook_runs_through.py

      volumeMounts:
        - mountPath: "/home/jovyan/ssh"
          name: ssh-volume
  volumes:
    - name: ssh-volume
      secret:
        secretName: jenkins-master-key
        defaultMode: 256
