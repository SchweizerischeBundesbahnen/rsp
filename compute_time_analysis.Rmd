---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
# %autosave 0
# %matplotlib notebook
# %matplotlib qt4
# %load_ext autoreload
# %autoreload 2
import sys
import pandas as pd
from IPython.display import Video

from rsp.utils.data_types import convert_list_of_experiment_results_analysis_to_data_frame
from rsp.utils.experiments import EXPERIMENT_DATA_SUBDIRECTORY_NAME
from rsp.utils.experiments import load_and_expand_experiment_results_from_data_folder
from rsp.analysis.compute_time_analysis import plot_computational_times
from rsp.analysis.compute_time_analysis import plot_histogram_from_delay_data
from rsp.analysis.compute_time_analysis import plot_speed_up
from rsp.analysis.compute_time_analysis import render_flatland_env
from rsp.analysis.compute_time_analysis import plot_route_dag
from rsp.schedule_problem_description.data_types_and_utils import ScheduleProblemEnum

from IPython.core.display import display, HTML
display(HTML("<style>.container { width:80% !important; }</style>"))
```

```{python}
experiments_of_interest = None
experiment_base_directory = '../rsp-data/h1_2020_08_24T21_04_42/h1_2020_08_24T21_04_42_baseline_2020_09_16T15_49_54'
experiment_results_list = load_and_expand_experiment_results_from_data_folder(
    experiment_data_folder_name=f'{experiment_base_directory}/{EXPERIMENT_DATA_SUBDIRECTORY_NAME}',
    experiment_ids=experiments_of_interest,
    nonify_problem_and_results=True
)
experiment_data: pd.DataFrame = convert_list_of_experiment_results_analysis_to_data_frame(experiment_results_list)

display(experiment_data)
```

```{python}
axis_of_interest = 'n_agents'
columns_of_interest = ['time_full','time_full_after_malfunction','time_delta_perfect_after_malfunction']
```

### Filter data depending on full rescheduling time (>10s and within 97% percentile)

```{python}
experiment_data_filtered = experiment_data[(experiment_data['time_full_after_malfunction'] > 10) & (experiment_data['time_full_after_malfunction'] <=experiment_data['time_full_after_malfunction'].quantile(.97))]

```

```{python}
print(f"removed {len(experiment_data)-len(experiment_data_filtered)}/{len(experiment_data)} rows")
```

### Visualize Compuational time comparison

```{python}
from rsp.analysis.detailed_experiment_analysis import hypothesis_one_analysis_visualize_computational_time_comparison
# display(experiment_data.dtypes)

hypothesis_one_analysis_visualize_computational_time_comparison(experiment_data=experiment_data_filtered)



# for exploration, use:
# plot_computational_times(experiment_data=experiment_data,
#                                   axis_of_interest=axis_of_interest,
#                                   columns_of_interest=columns_of_interest)
```

### Visualize Speed Up factors for experiments

```{python}
from rsp.analysis.detailed_experiment_analysis import hypothesis_one_analysis_visualize_speed_up
hypothesis_one_analysis_visualize_speed_up(experiment_data=experiment_data_filtered)

# for exploration, use:
# plot_speed_up(experiment_data=experiment_data,
#                        axis_of_interest=axis_of_interest)
```

### Visualize Online Prediction Quality

```{python}
axis_of_interest = 'experiment_id'
columns_of_interest = ['changed_agents_percentage_full_after_malfunction', 'online_predicted_changed_agents_percentage','online_predicted_changed_agents_false_positives_percentage', 'online_predicted_changed_agents_false_negatives_percentage']

plot_computational_times(experiment_data=experiment_data_filtered,
                         axis_of_interest=axis_of_interest,
                         columns_of_interest=columns_of_interest,
                         title='Online Prediction Quality Percentage',
                         color_offset=1
                        )
columns_of_interest = ['n_agents', 'changed_agents_full_after_malfunction', 'online_predicted_changed_agents','online_predicted_changed_agents_false_positives', 'online_predicted_changed_agents_false_negatives']

plot_computational_times(experiment_data=experiment_data_filtered,
                         axis_of_interest=axis_of_interest,
                         columns_of_interest=columns_of_interest,
                         title='Online Prediction Quality Absolute Numbers',
                        )
```
