---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python 3
    language: python
    name: python3
---

```{python}
# %autosave 0
# %matplotlib notebook
# %matplotlib qt4
# %load_ext autoreload
# %autoreload 2
import sys
sys.path.append("./flatland_ckua")
import pandas as pd
from IPython.display import Video

from rsp.utils.data_types import convert_list_of_experiment_results_analysis_to_data_frame, convert_pandas_series_experiment_results_analysis
from rsp.utils.experiments import EXPERIMENT_DATA_SUBDIRECTORY_NAME
from rsp.utils.experiments import load_and_expand_experiment_results_from_data_folder
from rsp.compute_time_analysis.compute_time_analysis import plot_computational_times
from rsp.compute_time_analysis.compute_time_analysis import plot_histogram_from_delay_data
from rsp.compute_time_analysis.compute_time_analysis import plot_resource_time_diagrams
from rsp.compute_time_analysis.compute_time_analysis import plot_speed_up
from rsp.compute_time_analysis.compute_time_analysis import render_flatland_env
from rsp.compute_time_analysis.compute_time_analysis import plot_route_dag
from rsp.compute_time_analysis.compute_time_analysis import plot_schedule_metrics
from rsp.compute_time_analysis.compute_time_analysis import plot_time_window_resource_trajectories
from rsp.compute_time_analysis.compute_time_analysis import plot_shared_heatmap
from rsp.compute_time_analysis.compute_time_analysis import extract_schedule_plotting


from rsp.schedule_problem_description.data_types_and_utils import ScheduleProblemEnum
```

```{python}
experiment_base_directory = '../rsp-data/agent_0_malfunction_2020_06_04T19_17_28/'
#experiment_base_directory = '../rsp-data/mini_toy_example'
experiment_of_interest = 0
```

```{python}
experiment_data_directory = f'{experiment_base_directory}/{EXPERIMENT_DATA_SUBDIRECTORY_NAME}'

exp_results_of_experiment_of_interest = load_and_expand_experiment_results_from_data_folder(
    experiment_data_folder_name=experiment_data_directory,
    experiment_ids=[experiment_of_interest],
    nonify_problem_and_results=False
)[0]
plotting_data = extract_schedule_plotting(experiment_result=exp_results_of_experiment_of_interest)
```


# Select specific experiment

```{python}
experiment_results_list = load_and_expand_experiment_results_from_data_folder(
    experiment_data_folder_name=experiment_data_directory,
    nonify_problem_and_results=False
)
for experiment in experiment_results_list:
#     print(experiment.experiment_id)
    for agent_id, topo in experiment.problem_delta_after_malfunction.topo_dict.items():
         for node, in_degree in topo.in_degree:
                if in_degree > 1 and agent_id != experiment.malfunction.agent_id:
                     print(f"experiment_id={experiment.experiment_id}, agent_id={agent_id}, node={node}, in_degree={in_degree}")
```

# Visualize problem for specific experiment

#### Time Resource Window Graph: time windows in scheduling problem per resource

```{python}
plot_time_window_resource_trajectories(experiment_result=exp_results_of_experiment_of_interest,plotting_information=plotting_data.plotting_information)
```

#### Resource Heat Map: how many potential resource conflicts on this resource?

```{python}
plot_shared_heatmap(experiment_result=exp_results_of_experiment_of_interest)
```

#### Route DAGs for individual agents

```{python}
# %matplotlib inline
agent_of_interest = 0
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_SCHEDULE)
```

```{python}
# %matplotlib inline
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_RSP_FULL)
```

```{python}
# %matplotlib inline
plot_route_dag(exp_results_of_experiment_of_interest,agent_of_interest, ScheduleProblemEnum.PROBLEM_RSP_DELTA)
```





# Visualize Solution of specific experiment

```{python}
choices_full_schedule = exp_results_of_experiment_of_interest.results_full.solver_statistics["solving"]["solvers"]["choices"]
choices_full_reschedule = exp_results_of_experiment_of_interest.results_full_after_malfunction.solver_statistics["solving"]["solvers"]["choices"]
choices_delta_reschedule = exp_results_of_experiment_of_interest.results_delta_after_malfunction.solver_statistics["solving"]["solvers"]["choices"]
```

```{python}
import pandas as pd
experiment_details = pd.DataFrame([exp_results_of_experiment_of_interest._asdict()],columns=['experiment_id','malfunction','size',
       'n_agents', 'max_num_cities', 'max_rail_between_cities',
       'max_rail_in_city', 'time_full', 'time_full_after_malfunction',
       'time_delta_after_malfunction','speed_up','nb_resource_conflicts_full',
       'nb_resource_conflicts_full_after_malfunction',
       'nb_resource_conflicts_delta_after_malfunction'])

experiment_details['choices_full_schedule'] = choices_full_schedule
experiment_details['choices_full_reschedule'] = choices_full_reschedule
experiment_details['choices_delta_reschedule'] = choices_delta_reschedule
display(experiment_details.transpose())
```





```{python}
changed_agents_traces = plot_resource_time_diagrams(schedule_plotting = plotting_data, with_diff=True)
```

```{python}
changed_agents = {a: True for a in [*changed_agents_traces]}
```

```{python}
plot_schedule_metrics(schedule_plotting=plotting_data, lateness_delta_after_malfunction=exp_results_of_experiment_of_interest.lateness_delta_after_malfunction)
```

```{python}
plot_histogram_from_delay_data(experiment_results=exp_results_of_experiment_of_interest)
```

#### Render the current environment

```{python}
video_src_schedule, video_src_reschedule=render_flatland_env(data_folder=experiment_base_directory ,experiment_data=exp_results_of_experiment_of_interest,experiment_id = experiment_of_interest)
```

```{python}
Video(video_src_schedule, embed=True)
```

```{python}
Video(video_src_reschedule, embed=True)
```

# ASP solver stats of specific experiment


```{python}
from rsp.experiment_solvers.asp.asp_helper import _print_stats
print("=================================================================================")
print(f"= {experiment_base_directory} results_full_after_malfunction ")
print("=================================================================================")
_print_stats(exp_results_of_experiment_of_interest.results_full_after_malfunction.solver_statistics)
print("=================================================================================")
print(f"= {experiment_base_directory} results_delta_after_malfunction ")
print("=================================================================================")
_print_stats(exp_results_of_experiment_of_interest.results_delta_after_malfunction.solver_statistics)
```

```{python}
#    list(filter(lambda s: s.startswith('shared'), exp_results_of_experiment_of_interest.results_full.solver_result))
```
