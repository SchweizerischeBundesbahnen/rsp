---
jupyter:
  jupytext:
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.2'
      jupytext_version: 1.4.1
  kernelspec:
    display_name: Python [conda env:.conda-rsp] *
    language: python
    name: conda-env-.conda-rsp-py
---

```{python}
# %autosave 0
# %matplotlib notebook
# %matplotlib qt4
# %load_ext autoreload
# %autoreload 2
import sys
sys.path.append("./flatland_ckua")
import pandas as pd
from IPython.display import Video

from rsp.utils.data_types import convert_list_of_experiment_results_analysis_to_data_frame, convert_pandas_series_experiment_results_analysis
from rsp.utils.experiments import EXPERIMENT_DATA_SUBDIRECTORY_NAME
from rsp.utils.experiments import load_and_expand_experiment_results_from_data_folder
from rsp.compute_time_analysis.compute_time_analysis import plot_computational_times
from rsp.compute_time_analysis.compute_time_analysis import plot_histogram_from_delay_data
from rsp.compute_time_analysis.compute_time_analysis import plot_speed_up
from rsp.compute_time_analysis.compute_time_analysis import render_flatland_env
from rsp.compute_time_analysis.compute_time_analysis import plot_route_dag
from rsp.compute_time_analysis.compute_time_analysis import plot_schedule_metrics
from rsp.compute_time_analysis.compute_time_analysis import plot_shared_heatmap
from rsp.compute_time_analysis.compute_time_analysis import trajectories_from_resource_occupations_per_agent
from rsp.compute_time_analysis.compute_time_analysis import extract_schedule_plotting
from rsp.compute_time_analysis.compute_time_analysis import plot_time_resource_trajectories, plot_resource_time_diagrams

from rsp.hypothesis_two_encounter_graph import compute_disturbance_propagation_graph, resource_occpuation_from_transmission_chains
from rsp.schedule_problem_description.data_types_and_utils import ScheduleProblemEnum
```

```{python}
experiment_base_directory = '../rsp-data/agent_0_malfunction_2020_06_04T19_17_28/'
experiment_of_interest = 0
```

```{python}
experiment_data_directory = f'{experiment_base_directory}/{EXPERIMENT_DATA_SUBDIRECTORY_NAME}'

experiment_results_list = load_and_expand_experiment_results_from_data_folder(
    experiment_data_folder_name=experiment_data_directory,
    experiment_ids=[experiment_of_interest],
    nonify_problem_and_results=False
)
experiment_data: pd.DataFrame = convert_list_of_experiment_results_analysis_to_data_frame(experiment_results_list)
```

```{python}
single_experiment_dataframe = experiment_data.loc[experiment_data['experiment_id'] == experiment_of_interest].iloc[0]
single_exp_results = convert_pandas_series_experiment_results_analysis(single_experiment_dataframe)
plotting_data = extract_schedule_plotting(experiment_result=single_exp_results)
```

### Disturbance Propagation Graphs



Compute the propagation wave from the malfunction with no re-scheduling

```{python}
transmission_chains, distance_matrix, weights_matrix, minimal_depth = compute_disturbance_propagation_graph(experiment_result=single_exp_results)
wave_resources = resource_occpuation_from_transmission_chains(transmission_chains)
wave_trajectory = trajectories_from_resource_occupations_per_agent(wave_resources,plotting_data.plotting_information)
```

```{python}
schedule_resource_occupations = plotting_data.schedule_as_resource_occupations.sorted_resource_occupations_per_agent
schedule_trajectories = trajectories_from_resource_occupations_per_agent(schedule_resource_occupations,plotting_data.plotting_information)
```

```{python}
reschedule_resource_occupations = plotting_data.reschedule_delta_as_resource_occupations.sorted_resource_occupations_per_agent
reschedule_trajectories = trajectories_from_resource_occupations_per_agent(reschedule_resource_occupations,plotting_data.plotting_information)
```

```{python}
plot_time_resource_trajectories(title="Schedule Propagation",trajectories=schedule_trajectories,ranges=plotting_data.plotting_information.dimensions,malfunction=plotting_data.malfunction,malfunction_wave=wave_trajectory)
```

```{python}
    
```

```{python}

```
